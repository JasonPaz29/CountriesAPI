<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>World Countries — (with AI) Frontend</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#071027;--muted:#9fb3cf;--accent:#7be495}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:#eaf2ff}
    /* world-map background (public domain/svg) */
    body{
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(6,10,20,0.35),rgba(6,10,20,0.6));z-index:1}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 28px;position:relative;z-index:3;background:linear-gradient(90deg, rgba(0,0,0,0.25), rgba(0,0,0,0.15));backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,0.03)}
  .top-nav{display:flex;gap:8px;align-items:center}
  .top-nav button{padding:6px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--muted);cursor:pointer}
  .top-nav button.active{background:var(--accent);color:#042018;font-weight:700}
  main{display:flex;align-items:center;justify-content:center;margin-top:6vh;position:relative;z-index:2}
    .center-box{min-height:54vh;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:14px;padding:18px 20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(6px);box-shadow:0 8px 28px rgba(2,6,23,0.6);position:relative;overflow:hidden;max-width:980px;margin-inline:auto}
    .fn-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;width:100%}
    .fn-card{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    a { color: var(--accent) }
    code { font-family:ui-monospace,Menlo,monospace; color:var(--muted) }
  .site-footer{position:fixed;left:0;right:0;bottom:10px;text-align:center;color:var(--muted);z-index:4;font-size:0.95rem}
  .site-footer .by{opacity:0.85;margin-top:4px;font-size:0.85rem}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
</head>
<body>
  <div class="overlay"></div>
    <header>
    <div style="font-weight:700">World Countries API</div>
    <div class="top-nav">
      <button onclick="showPage('homePage')" id="tabHome">Home</button>
      <button onclick="showPage('functionsPage')" id="tabFunctions">Functions</button>
      <button onclick="showPage('comparePage')" id="tabCompare">Compare</button>
    </div>
    <div id="apiStatus" style="font-size:0.92rem;color:var(--muted)">checking API…</div>
  </header>

  <main>
    <div class="center-box">
      <div style="width:100%;display:flex;justify-content:flex-start;align-items:center;margin-bottom:12px">
        <h2 style="margin:0">Explore</h2>
      </div>

      <div id="homePage" class="page active" style="width:100%">
        <div style="margin-bottom:10px;color:var(--muted)">Search countries (uses API when reachable)</div>
        <div style="margin-bottom:15px;color:var(--muted)">Any Data, Any Country, Anytime</div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="searchInput" placeholder="Search country name..." style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);width:380px" />
          <button onclick="doSearch()">Search</button>
        </div>
        <div id="searchResults" style="margin-top:12px"></div>
      </div>

      <div id="functionsPage" class="page" style="display:none;width:100%">
        <h3 style="margin-top:0">API Functions</h3>
        <div id="functionsGrid" class="fn-grid"></div>
      </div>

      <div id="comparePage" class="page" style="display:none;width:100%">
        <h3 style="margin-top:0">Compare Countries</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <select id="compareA" style="padding:8px;border-radius:6px;background:#071027;color:#eaf2ff"></select>
          <select id="compareB" style="padding:8px;border-radius:6px;background:#071027;color:#eaf2ff"></select>
          <button onclick="doCompare()">Compare</button>
        </div>
        <div id="compareResults"></div>
      </div>
    </div>
  </main>

  <script>window.API_BASE = 'http://127.0.0.1:8000/api';</script>
  <script>
    // configuration — can be overridden by setting window.API_BASE before this script runs
    const apiBase = (window.API_BASE && window.API_BASE.replace(/\/+$/,'')) || 'http://127.0.0.1:5000/api';
    let apiEnabled = false;

    // simple helpers
    const el = (s)=>document.querySelector(s);
    const setApiStatus = (text,color)=>{ const st = el('#apiStatus'); if(st){ st.textContent=text; st.style.color=color; } };

    // functions list that mirrors backend endpoints
    const functionsList = [
      { title:'Search countries', example:'/api/countries?name=France', params:'name, region, min_population, min_gdp', desc:'Search countries with filters' },
      { title:'Single country', example:'/api/countries/1', params:'id', desc:'Get a single country profile by id' },
      { title:'Compare', example:'/api/countries/compare/1/2', params:'id1, id2', desc:'Compare two countries' },
      { title:'Top economies', example:'/api/countries/top_economies', params:'limit', desc:'Top economies by GDP' },
      { title:'Most populated', example:'/api/countries/most_populated_countries', params:'limit', desc:'Most populated countries' },
      { title:'Country cities', example:'/api/countries/1/cities', params:'country_id', desc:'Cities for a country' },
      { title:'Capital lookup', example:'/api/countries/capital/London', params:'capital', desc:'Find country by capital' },
      { title:'Economies stats', example:'/api/economies/stats', params:'', desc:'Aggregated economy statistics' }
    ];

    // render functions — clickable absolute API links only when API reachable
    function renderFunctions(){
      const grid = el('#functionsGrid'); grid.innerHTML='';
      functionsList.forEach(f=>{
        const card = document.createElement('div'); card.className='fn-card';
        let exampleHTML;
        if(apiEnabled){
          // build absolute url for clickable example
          const abs = apiBase + f.example.replace(/^\/api/,'');
          exampleHTML = `<a href="${abs}" target="_blank" rel="noopener">${abs}</a>`;
        } else {
          exampleHTML = `<code>${f.example}</code>`;
        }
        card.innerHTML = `<h4 style="margin:6px 0">${f.title}</h4><div style="color:var(--muted)">${f.desc}</div><div style="margin-top:8px;color:var(--muted)"><strong>Params:</strong> ${f.params || '—'}</div><div style="margin-top:8px"><strong>Example:</strong> ${exampleHTML}</div>`;
        grid.appendChild(card);
      });
    }

    // populate compare select inputs with countries (simple load)
    async function populateCompareSelects(){
      try{
        const r = await fetch(apiBase + '/countries?name=');
        const data = await r.json();
        const selA = el('#compareA'); const selB = el('#compareB');
        if(!selA || !selB) return;
        selA.innerHTML = '<option value="">Select country A</option>';
        selB.innerHTML = '<option value="">Select country B</option>';
        data.forEach(c=>{
          const optA = document.createElement('option'); optA.value=c.id; optA.textContent=c.name; selA.appendChild(optA);
          const optB = document.createElement('option'); optB.value=c.id; optB.textContent=c.name; selB.appendChild(optB);
        });
      }catch(e){ /* ignore */ }
    }

    async function doCompare(){
      const a = el('#compareA').value; const b = el('#compareB').value;
      if(!a || !b){ el('#compareResults').textContent='Please select two countries.'; return; }
      el('#compareResults').textContent='Comparing...';
      try{
        const r = await fetch(apiBase + '/countries/compare/' + a + '/' + b);
        if(!r.ok) { el('#compareResults').textContent='Compare failed'; return; }
        const arr = await r.json();
        // render side-by-side table
        const left = arr[0], right = arr[1];
        el('#compareResults').innerHTML = renderCompareTable(left, right);
      }catch(e){ el('#compareResults').textContent='Compare error: '+ (e.message||e); }
    }

    function renderCompareTable(l, r){
      const rows = [
        ['Name', l.name, r.name],
        ['Capital', l.capital, r.capital],
        ['Population', l.population?.toLocaleString(), r.population?.toLocaleString()],
        ['Region', l.region, r.region],
        ['GDP (billion)', (l.economy?.gdp||'—'), (r.economy?.gdp||'—')],
        ['Currency', (l.economy?.currency||'—'), (r.economy?.currency||'—')],
        ['HDI', (l.humanIndex?.index||'—'), (r.humanIndex?.index||'—')]
      ];
      const head = `<table style="width:100%;border-collapse:collapse"><thead><tr><th style='text-align:left;padding:8px'></th><th style='padding:8px'>A</th><th style='padding:8px'>B</th></tr></thead>`;
      const body = rows.map(row=>`<tr><td style='padding:8px;font-weight:600'>${row[0]}</td><td style='padding:8px'>${row[1]??'—'}</td><td style='padding:8px'>${row[2]??'—'}</td></tr>`).join('');
      return head + '<tbody>' + body + '</tbody></table>';
    }

    // basic API reachability check with timeout
    async function checkApi(timeoutMs=1500){
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), timeoutMs);
      try{
        const resp = await fetch(apiBase + '/countries?name=', { signal: controller.signal });
        if(resp.ok){
          apiEnabled = true;
          setApiStatus('API: reachable', 'var(--accent)');
        } else {
          apiEnabled = false;
          setApiStatus('API: offline (using CSV)', 'var(--muted)');
        }
      }catch(e){
        apiEnabled = false;
        setApiStatus('API: offline (using CSV)', 'var(--muted)');
      }finally{ clearTimeout(id); renderFunctions(); }
    }

    // simple search that prefers API when available, otherwise will fallback to client CSV (not included here)
    async function doSearch(){
      const q = el('#searchInput').value.trim();
      el('#searchResults').textContent = 'Searching...';
      try{
        if(apiEnabled){
          const r = await fetch(apiBase + '/countries?name=' + encodeURIComponent(q));
          const data = await r.json();
          if(!data.length){ el('#searchResults').innerHTML = '<div style="color:var(--muted)">No results</div>'; return; }
          // take the first match and fetch richer details from auxiliary endpoints
          const country = data[0];
          const extras = await fetchCountryExtras(country.id);
          el('#searchResults').innerHTML = renderDetailsTable(country, extras);
        } else {
          el('#searchResults').innerHTML = '<div style="color:var(--muted)">CSV fallback not loaded in this version — start with API enabled.</div>';
        }
      }catch(err){
        el('#searchResults').textContent = 'Search failed: ' + (err.message || err);
      }
    }

    // fetch additional data: development, cities, languages and economy
    async function fetchCountryExtras(id){
      try{
        const [devResp, citiesResp, langsResp, econResp] = await Promise.all([
          fetch(apiBase + '/countries/' + id + '/development'),
          fetch(apiBase + '/countries/' + id + '/cities'),
          fetch(apiBase + '/languages'),
          fetch(apiBase + '/economies')
        ]);
        const dev = devResp.ok ? await devResp.json() : null;
        const cities = citiesResp.ok ? await citiesResp.json() : [];
        const langsAll = langsResp.ok ? await langsResp.json() : [];
        // languages endpoint returns language objects with countries (ids)
        const languages = langsAll.filter(l=> (l.countries || []).includes(id));
        const economies = econResp.ok ? await econResp.json() : [];
        const economy = economies.find(e=> e.country_id === id) || null;
        return { dev, cities, languages, economy };
      }catch(e){ return { dev:null, cities:[], languages:[], economy:null }; }
    }

    function renderDetailsTable(country, extras){
      const lang = extras.languages && extras.languages.length ? extras.languages[0].name : '—';
      const hdi = extras.dev && extras.dev.index != null ? extras.dev.index : '—';
      const devClass = extras.dev && extras.dev.development_class ? extras.dev.development_class : '—';
      const gdp = extras.economy && extras.economy.gdp != null ? extras.economy.gdp : '—';
      const currency = extras.economy && extras.economy.currency ? extras.economy.currency : '—';
      const cities = extras.cities && extras.cities.length ? extras.cities.map(c=>c.name).join(', ') : '—';

      return `
        <div style="margin-top:8px">
          <h3 style="margin:6px 0">${country.name}</h3>
          <table style="width:100%;border-collapse:collapse;color:#eaf2ff">
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">Capital</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${country.capital || '—'}</td></tr>
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">Main language</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${lang}</td></tr>
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">Human Development Index (HDI)</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${hdi}</td></tr>
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">Development class</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${devClass}</td></tr>
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">GDP (billion USD)</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${gdp}</td></tr>
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">Currency</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${currency}</td></tr>
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">Population</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${country.population.toLocaleString()}</td></tr>
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">Region</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${country.region}</td></tr>
            <tr><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03);font-weight:600">Major cities</td><td style="padding:6px 8px;border-top:1px solid rgba(255,255,255,0.03)">${cities}</td></tr>
          </table>
        </div>
      `;
    }

    // page + hero slideshow control (single canonical showPage)
    let heroTimer = null;
    function startHeroSlideshow(){
      stopHeroSlideshow();
      heroTimer = setInterval(()=>{/* placeholder for slideshow tick */}, 5000);
    }
    function stopHeroSlideshow(){ if(heroTimer){ clearInterval(heroTimer); heroTimer = null; } }

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.style.display='none');
      const pg = document.getElementById(id);
      if(pg){ pg.style.display='block'; }
      // start hero only on home
      if(id === 'homePage') startHeroSlideshow(); else stopHeroSlideshow();
  // expand center box for functions page to show more content
  const cb = document.querySelector('.center-box');
  if(id === 'functionsPage'){ cb.style.maxWidth = '1200px'; cb.style.minHeight='72vh'; } else { cb.style.maxWidth='980px'; cb.style.minHeight='54vh'; }
      // tab button active state (simple)
      document.querySelectorAll('header button, header div button').forEach(b=>b.classList.remove('active'));
      const btn = document.querySelector(`#tab${id==='homePage'?'Home':'Functions'}`);
      if(btn) btn.classList.add('active');
  if(id === 'comparePage'){ populateCompareSelects(); }
    }

    // init
    (function init(){
      renderFunctions();
      checkApi();
      showPage('homePage');
    })();
  </script>
  <div class="site-footer">
    <div class="tagline">Explore the world!</div>
    <div class="by">Created by Jason Paz-Romero and Sriram Joshi</div>
  </div>
</body>
</html>